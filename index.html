<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>×œ×•×— ×¦'××˜ - ××©×ª××©×™ ×§×¦×”</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <!-- Auth overlay for token input -->
      <div class="auth-overlay" id="authOverlay">
        <div class="auth-container">
          <h2>×”×–× ×ª ××¤×ª×— ×’×™×©×”</h2>
          <p>×× × ×”×–×Ÿ ××ª ××¤×ª×— ×”×’×™×©×” ×©×œ×š ×œ×”××©×š</p>
          <div class="auth-form">
            <input type="text" id="tokenInput" placeholder="×”×–×Ÿ ××¤×ª×— ×’×™×©×”" />
            <button id="submitToken">×”××©×š</button>
          </div>
          <div class="auth-error" id="authError"></div>
        </div>
      </div>

      <div class="conversation-view" id="conversationView">
        <div class="empty-state" id="emptyState">
          <div class="empty-state-icon">ğŸ’¬</div>
          <h3>×‘×—×¨ ×©×™×—×”</h3>
          <p>×œ×—×¥ ×¢×œ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×›×“×™ ×œ×¦×¤×•×ª ×‘×©×™×—×”</p>
        </div>
      </div>

      <div class="users-list" id="usersList">
        <h2 style="padding: 16px">×©×™×—×•×ª</h2>
        <div class="loading" id="loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>

    <script>
      // DOM Elements
      const usersList = document.getElementById("usersList");
      const conversationView = document.getElementById("conversationView");
      const loading = document.getElementById("loading");
      const emptyState = document.getElementById("emptyState");
      const authOverlay = document.getElementById("authOverlay");
      const tokenInput = document.getElementById("tokenInput");
      const submitToken = document.getElementById("submitToken");
      const authError = document.getElementById("authError");

      // State
      let users = [];
      let selectedUserId = null;
      let isMobile = window.innerWidth <= 768;
      let token = null;
      const STORE_ID = 1;
      const TOKEN_STORAGE_KEY = "chat_board_token";

      // Format date to local time
      function formatDate(dateString) {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat("he-IL", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        }).format(date);
      }

      // Format relative time
      function formatRelativeTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) {
          return "×–×” ×¢×ª×”";
        } else if (diffInSeconds < 3600) {
          const minutes = Math.floor(diffInSeconds / 60);
          return `×œ×¤× ×™ ${minutes} ${minutes === 1 ? "×“×§×”" : "×“×§×•×ª"}`;
        } else if (diffInSeconds < 86400) {
          const hours = Math.floor(diffInSeconds / 3600);
          return `×œ×¤× ×™ ${hours} ${hours === 1 ? "×©×¢×”" : "×©×¢×•×ª"}`;
        } else if (diffInSeconds < 604800) {
          const days = Math.floor(diffInSeconds / 86400);
          return `×œ×¤× ×™ ${days} ${days === 1 ? "×™×•×" : "×™××™×"}`;
        } else {
          return formatDate(dateString);
        }
      }

      // Get last message preview
      function getLastMessagePreview(messages) {
        if (!messages || messages.length === 0) return "";
        const lastMessage = messages[messages.length - 1];
        return (
          lastMessage.content.substring(0, 50) +
          (lastMessage.content.length > 50 ? "..." : "")
        );
      }

      // Save token to localStorage
      function saveToken(token) {
        localStorage.setItem(TOKEN_STORAGE_KEY, token);
      }

      // Get token from localStorage
      function getTokenFromStorage() {
        return localStorage.getItem(TOKEN_STORAGE_KEY);
      }

      // Validate token function
      async function validateToken(inputToken) {
        try {
          const response = await fetch(
            "https://bbot.genericgs.com/chat-board/end-users/all",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                token: inputToken,
                store_id: STORE_ID,
              }),
            }
          );

          if (!response.ok) {
            throw new Error("Token invalid");
          }

          // Token is valid
          token = inputToken;
          saveToken(token);
          hideAuthOverlay();

          // Process the data
          const data = await response.json();
          users = data;
          renderUsersList();

          return true;
        } catch (error) {
          console.error("Token validation error:", error);
          return false;
        }
      }

      // Fetch data from API
      async function fetchData() {
        if (!token) {
          showAuthOverlay();
          return;
        }

        loading.style.display = "block";

        try {
          const response = await fetch(
            "https://bbot.genericgs.com/chat-board/end-users/all",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                token: token,
                store_id: STORE_ID,
              }),
            }
          );

          if (!response.ok) {
            // If token is no longer valid
            if (response.status === 401 || response.status === 403) {
              // Clear invalid token
              localStorage.removeItem(TOKEN_STORAGE_KEY);
              token = null;
              showAuthOverlay();
              throw new Error("Token invalid");
            }
            throw new Error("Network response was not ok");
          }

          const data = await response.json();
          users = data;
          renderUsersList();
        } catch (error) {
          console.error("Error:", error);
          loading.innerHTML = `
                    <div class="error-message">
                        × ×›×©×œ ×‘×˜×¢×™× ×ª × ×ª×•× ×™×. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.
                        <p>${error.message}</p>
                    </div>
                `;
        }
      }

      // Show auth overlay
      function showAuthOverlay() {
        authOverlay.style.display = "flex";
      }

      // Hide auth overlay
      function hideAuthOverlay() {
        authOverlay.style.display = "none";
      }

      // Render users list
      function renderUsersList() {
        loading.style.display = "none";

        if (!users || users.length === 0) {
          usersList.innerHTML =
            '<div class="empty-state"><h3>×œ× × ××¦××• ×©×™×—×•×ª</h3></div>';
          return;
        }

        // Sort users by last message time (newest first)
        users.sort((a, b) => {
          return new Date(b.last_msg_time) - new Date(a.last_msg_time);
        });

        usersList.innerHTML = '<h2 style="padding: 16px;">×©×™×—×•×ª</h2>';

        users.forEach((user) => {
          const userItem = document.createElement("div");
          userItem.className = `user-item ${
            user.id === selectedUserId ? "active" : ""
          }`;
          userItem.dataset.id = user.id;

          const lastMessagePreview = getLastMessagePreview(user.messages);
          const lastMessageTime = formatRelativeTime(user.last_msg_time);

          userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-phone">${user.phone_number}</div>
                        <div class="last-message-time">${lastMessageTime}</div>
                    </div>
                    <div class="message-preview">${lastMessagePreview}</div>
                `;

          userItem.addEventListener("click", () => {
            selectUser(user.id);
          });

          usersList.appendChild(userItem);
        });
      }

      function selectUser(userId) {
        selectedUserId = userId;
        const selectedUser = users.find((user) => user.id === userId);

        // Update active class
        document.querySelectorAll(".user-item").forEach((item) => {
          item.classList.remove("active");
        });

        const activeItem = document.querySelector(
          `.user-item[data-id="${userId}"]`
        );
        if (activeItem) {
          activeItem.classList.add("active");
        }

        // Always hide the empty state when a user is selected
        emptyState.style.display = "none";

        // Show conversation view and hide users list on mobile
        if (isMobile) {
          usersList.classList.add("hide");
          conversationView.classList.add("active");
        }

        if (!selectedUser.messages || selectedUser.messages.length === 0) {
          emptyState.style.display = "flex";
          return;
        }

        renderConversation(selectedUser);
      }
      // Render conversation
      function renderConversation(user) {
        if (!user) {
          conversationView.innerHTML =
            '<div class="empty-state"><h3>××©×ª××© ×œ× × ××¦×</h3></div>';
          return;
        }

        emptyState.style.display = "none";

        let backButton = "";
        if (isMobile) {
          backButton = `
                    <button class="back-button" id="backButton">
                        â†’ ×—×–×¨×” ×œ×©×™×—×•×ª
                    </button>
                `;
        }

        const formattedMessages = formatMessages(user.messages);

        conversationView.innerHTML = `
                <div class="conversation-header">
                    ${backButton}
                    <h2>×˜×œ×¤×•×Ÿ: ${user.phone_number}</h2>
                </div>
                <div class="conversation-body" id="conversationBody">
                    ${formattedMessages}
                </div>
            `;

        // Add back button event listener
        const backButtonEl = document.getElementById("backButton");
        if (backButtonEl) {
          backButtonEl.addEventListener("click", () => {
            // Show user list and hide conversation view
            usersList.classList.remove("hide");
            conversationView.classList.remove("active");

            // Reset the empty state display to handle the case
            // when there's no conversation selected
            if (!selectedUserId) {
              emptyState.style.display = "flex";
            }
          });
        }

        // Scroll to bottom of conversation
        const conversationBody = document.getElementById("conversationBody");
        conversationBody.scrollTop = conversationBody.scrollHeight;
      }

      // Format messages for display
      function formatMessages(messages) {
        if (!messages || messages.length === 0) {
          return '<div class="empty-message">×œ× × ××¦××• ×”×•×“×¢×•×ª</div>';
        }

        // Sort messages by created time
        messages.sort((a, b) => {
          return new Date(a.created) - new Date(b.created);
        });

        let html = "";
        let currentSender = null;
        let messageGroup = "";

        messages.forEach((message, index) => {
          const formattedTime = formatDate(message.created);
          const isClient = message.sent_by === "client";
          const messageClass = isClient ? "message-client" : "message-business";

          // If sender changed or this is the first message, start a new group
          if (message.sent_by !== currentSender || index === 0) {
            // Add previous message group to HTML if it exists
            if (messageGroup) {
              html += `<div class="message-group">${messageGroup}</div>`;
              messageGroup = "";
            }
            currentSender = message.sent_by;
          }

          // Add message to current group
          messageGroup += `
                    <div class="message ${messageClass}">
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${formattedTime}</div>
                    </div>
                `;

          // If this is the last message, add the group to HTML
          if (index === messages.length - 1) {
            html += `<div class="message-group">${messageGroup}</div>`;
          }
        });

        return html;
      }

      // Check if device is mobile
      function checkIfMobile() {
        isMobile = window.innerWidth <= 768;
      }

      // Submit token from form
      function submitTokenHandler() {
        const inputToken = tokenInput.value.trim();

        if (!inputToken) {
          authError.textContent = "×× × ×”×–×Ÿ ××¤×ª×— ×’×™×©×”";
          return;
        }

        authError.textContent = "";

        validateToken(inputToken)
          .then((isValid) => {
            if (!isValid) {
              authError.textContent = "××¤×ª×— ×’×™×©×” ×©×’×•×™";
            }
          })
          .catch((error) => {
            authError.textContent = "××™×¨×¢×” ×©×’×™××”. ×× × × ×¡×” ×©×•×‘.";
            console.error("Token submission error:", error);
          });
      }

      // Initialize
      function init() {
        checkIfMobile();

        // Event listeners
        submitToken.addEventListener("click", submitTokenHandler);

        tokenInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            submitTokenHandler();
          }
        });

        // Add window resize event listener
        window.addEventListener("resize", checkIfMobile);

        // Check for token in localStorage
        token = getTokenFromStorage();

        if (token) {
          // Try to fetch data with stored token
          fetchData();
        } else {
          // Show auth overlay
          showAuthOverlay();
        }
      }

      // Start the app
      init();
    </script>
  </body>
</html>
